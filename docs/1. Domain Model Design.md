# Loyalty System: Domain Model Design Document

## 1. Introduction

This document describes the domain model for a flexible loyalty system supporting both stamp-based and points-based loyalty programs. It defines the core entities, their relationships, business rules, and key workflows that form the foundation of the system.

## 2. Domain Model Overview

### 2.1 Core Concepts

The loyalty system is built around these core concepts:

- **Brand**: A business entity that offers loyalty programs to its customers
- **Store**: A physical or online location belonging to a brand
- **Loyalty Program**: A set of rules defining how loyalty is earned and rewarded
- **Loyalty Card**: A customer's membership in a loyalty program
- **Transaction**: A record of loyalty activity (stamp/point issuance or reward redemption)
- **Reward**: An incentive offered to customers who accumulate sufficient loyalty (stamps or points)

## 3. Entities and Aggregates

### 3.1 Brand

**Entity Properties:**
- ID (Unique identifier)
- Name (Business name)
- Category (Industry/category)
- Logo (URL to image)
- Description (Business description)
- Contact information (Email, phone, website)
- Address (Physical address)

**Responsibilities:**
- Contains business identity and branding information
- Parent entity for Stores and Loyalty Programs
- Controls brand-level settings and configurations

### 3.2 Store

**Entity Properties:**
- ID (Unique identifier)
- BrandID (Reference to owning Brand)
- Name (Store name/location)
- Address (Physical location)
- GeoLocation (Coordinates for geofencing/fraud detection)
- OperatingHours (Business hours)
- ContactInfo (Phone, email)

**Responsibilities:**
- Represents a physical or virtual location where loyalty transactions occur
- May have specific fraud prevention settings (geofencing, operating hours)
- Used for store-level analytics and reporting

### 3.3 LoyaltyProgram (Aggregate Root)

**Entity Properties:**
- ID (Unique identifier)
- BrandID (Reference to owning Brand)
- Name (Program name)
- Type (Stamp-based or Points-based)
- StampThreshold (For stamp-based, stamps needed for reward)
- PointsConversionRate (For points-based, e.g., $1 = 1 point)
- DailyStampLimit (Optional maximum stamps per day)
- MinimumTransactionAmount (Optional minimum purchase for points)
- ExpirationPolicy (Rules for when loyalty expires)
- Collection of Rewards

**Responsibilities:**
- Defines the rules of the loyalty program
- Enforces business constraints (limits, thresholds)
- Manages the program's rewards
- Controls stamp/point issuance policies

**Business Rules:**
- A program must be either Stamp-based or Points-based
- Stamp-based programs may define a required stamp count for rewards
- Points-based programs define a conversion rate for purchases
- Programs may set optional constraints (daily limits, minimum purchases)
- Programs can define how loyalty (stamps/points) expires

### 3.4 LoyaltyCard (Aggregate Root)

**Entity Properties:**
- ID (Unique identifier)
- ProgramID (Reference to LoyaltyProgram)
- CustomerID (Reference to Customer)
- Type (Stamp-based or Points-based, matching Program type)
- StampsCollected (For stamp-based cards)
- PointsBalance (For points-based cards)
- Status (Active, Expired, Suspended)
- CreatedAt (Enrollment date)
- ExpiresAt (Optional expiration date)
- Collection of Transactions

**Responsibilities:**
- Tracks a customer's loyalty progress (stamps or points)
- Enforces rules for stamp/point issuance and reward redemptions
- Maintains transaction history
- Validates card status and expiration

**Business Rules:**
- A card must have matching Type with its program
- Cards must be active to receive stamps/points or redeem rewards
- Cards enforce daily stamp limits from their program
- Points-based cards enforce minimum transaction amounts
- Cards track their transaction history for auditing and analytics
- Expired cards cannot perform transactions

### 3.5 Transaction (Entity)

**Entity Properties:**
- ID (Unique identifier)
- CardID (Reference to LoyaltyCard)
- Type (StampIssuance, PointsIssuance, RewardRedemption, StampVoid, PointsVoid)
- RewardID (Optional reference to Reward for redemptions)
- Quantity (For stamps transactions)
- PointsAmount (For points transactions)
- TransactionAmount (For POS-linked transactions)
- StoreID (Where transaction occurred)
- StaffID (Optional reference to staff member)
- PosTransactionID (Optional reference to external POS system)
- Timestamp (When transaction occurred)
- Metadata (Additional transaction data)

**Responsibilities:**
- Records all loyalty activities for auditing and analytics
- Links to external systems (POS) when relevant
- Provides data for anti-fraud monitoring
- Supplies data for customer history and reporting

### 3.6 Reward (Entity)

**Entity Properties:**
- ID (Unique identifier)
- ProgramID (Reference to LoyaltyProgram)
- Title (Reward name)
- Description (What the customer receives)
- RequiredValue (Stamps or points needed)
- ValidFrom (Optional start date)
- ValidTo (Optional end date)
- IsActive (Whether reward is currently offered)

**Responsibilities:**
- Defines what customers can earn with their loyalty
- Controls reward validity periods
- Enforces redemption requirements (stamp/point thresholds)

**Business Rules:**
- Rewards have a required value (stamps or points)
- Rewards may have optional validity periods
- Rewards can be activated or deactivated
- Rewards belong to a specific loyalty program

## 4. Business Rules and Invariants

### 4.1 Loyalty Card Rules

1. **Card Type Consistency**:
   - A card's type (Stamp/Points) must match its program's type
   - Stamp-based cards track StampsCollected
   - Points-based cards track PointsBalance

2. **Card Status**:
   - Only Active cards can receive stamps/points or redeem rewards
   - Expired or Suspended cards cannot perform transactions
   - Cards have a status lifecycle: Active → Expired or Active → Suspended

3. **Daily Stamp Limits**:
   - If a program has a DailyStampLimit, cards cannot exceed this limit
   - The limit is enforced across all stores for the same day

4. **Points-based Transaction Rules**:
   - Points are calculated based on the program's PointsConversionRate
   - Transactions below MinimumTransactionAmount (if set) earn no points

### 4.2 Reward Redemption Rules

1. **Balance Requirements**:
   - Stamp-based: StampsCollected ≥ Reward.RequiredValue
   - Points-based: PointsBalance ≥ Reward.RequiredValue

2. **Validity Period**:
   - Rewards can only be redeemed during their validity period
   - A reward must be Active to be redeemable

3. **Program Consistency**:
   - Rewards can only be redeemed against cards in the same program

4. **Balance Deduction**:
   - Stamp redemptions reduce StampsCollected by RequiredValue
   - Points redemptions reduce PointsBalance by RequiredValue

### 4.3 Transaction Integrity Rules

1. **Timestamps**:
   - All transactions must have valid timestamps
   - Transactions cannot be backdated to circumvent daily limits

2. **Store Validation**:
   - Transactions must occur at stores belonging to the program's brand

3. **Staff Authorization**:
   - Staff-initiated transactions must have a valid StaffID with appropriate permissions

4. **POS Integration**:
   - POS-linked transactions should include PosTransactionID for reconciliation
   - External transaction amounts should be validated against program rules

## 5. Key Domain Services

### 5.1 LoyaltyCardService

**Responsibilities:**
- Customer enrollment in loyalty programs
- Card creation, activation, and expiration management
- Handling card lifecycle events

### 5.2 LoyaltyTransactionService

**Responsibilities:**
- Processing stamp issuance requests
- Processing points addition from purchases
- Validating transaction rules (daily limits, minimum amounts)
- Recording all loyalty transactions

### 5.3 RewardRedemptionService

**Responsibilities:**
- Validating reward eligibility
- Processing reward redemptions
- Managing reward validity and availability
- Tracking redemption history

### 5.4 CardLinkService

**Responsibilities:**
- Managing the linking of payment methods to loyalty cards
- Processing POS integration data
- Mapping transaction hashes to customer cards

## 6. Key Workflows

### 6.1 Stamp Issuance Workflow

1. Staff identifies customer via QR code scan or lookup
2. System retrieves customer's loyalty card
3. System validates card status and program rules
4. System checks daily stamp limit compliance
5. If valid, stamps are issued and recorded as a transaction
6. Customer and staff receive confirmation
7. StampsIssuedEvent is published for notifications/analytics

### 6.2 Points Addition Workflow (POS Integration)

1. Customer makes purchase and provides loyalty identifier (QR/card/phone)
2. POS system sends transaction data to loyalty API
3. System identifies customer's loyalty card
4. System validates transaction amount against program rules
5. System calculates points based on conversion rate
6. Points are added to card and recorded as a transaction
7. PointsAddedEvent is published for notifications/analytics
8. Customer receives confirmation (receipt, notification, etc.)

### 6.3 Reward Redemption Workflow

1. Staff identifies customer via QR code scan or lookup
2. System retrieves customer's available rewards based on loyalty balance
3. Staff selects reward to redeem with customer
4. System validates reward eligibility (balance, validity period)
5. System processes redemption, deducts stamps/points, records transaction
6. RewardRedeemedEvent is published for notifications/analytics
7. Customer and staff receive confirmation

## 7. Integration Events

To support an event-driven architecture, these domain events will be published:

### 7.1 LoyaltyCardCreatedEvent
- Triggered when a customer enrolls in a loyalty program
- Contains: CardID, CustomerID, ProgramID, ProgramType, Timestamp

### 7.2 StampsIssuedEvent
- Triggered when stamps are issued to a card
- Contains: CardID, CustomerID, StampsIssued, TotalStamps, StoreID, Timestamp

### 7.3 PointsAddedEvent
- Triggered when points are added to a card
- Contains: CardID, CustomerID, PointsAdded, PointsBalance, TransactionAmount, StoreID, Timestamp

### 7.4 RewardRedeemedEvent
- Triggered when a reward is redeemed
- Contains: CardID, CustomerID, RewardID, RewardTitle, StoreID, Timestamp

### 7.5 LoyaltyExpiringEvent
- Triggered when stamps/points are approaching expiration
- Contains: CardID, CustomerID, ExpiringValue, ExpirationDate

## The 8. Validation and Open Questions

1. **Card Expiration Strategy**:
   - How should we handle partial expiration of points/stamps?
   - Should we implement a "first in, first out" model for expiration?

2. **Multi-Brand Considerations**:
   - How will customers view/manage multiple loyalty cards across different brands?
   - Should we support a "master loyalty" concept across multiple brands?

3. **Fraud Prevention**:
   - What additional rules should be implemented to prevent loyalty fraud?
   - How strict should geofencing and time-based rules be?

4. **POS Integration Complexity**:
   - What happens if a POS transaction is voided after points are awarded?
   - How do we handle connectivity issues with in-store systems?

5. **Performance Considerations**:
   - How do we optimize for high-volume issuance scenarios?
   - Should transaction history be partitioned for performance? 