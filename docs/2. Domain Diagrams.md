# Loyalty System: Domain Model Diagrams

This document contains various diagrams representing the domain model in Mermaid format.

## 1. Core Domain Model (Class Diagram)

```mermaid
classDiagram
    class Business {
        +Guid Id
        +string Name
        +string Description
        +string TaxId
        +string Logo
        +string Website
        +DateTime FoundedDate
        +bool IsActive
        +ContactInfo Contact
        +Address HeadquartersAddress
    }
    
    class Brand {
        +Guid Id
        +Guid BusinessId
        +string Name
        +string Category
        +string Logo
        +string Description
        +ContactInfo Contact
    }
    
    class Store {
        +Guid Id
        +Guid BrandId
        +string Name
        +Address Address
        +GeoLocation Location
        +OperatingHours Hours
        +string ContactInfo
    }
    
    class LoyaltyProgram {
        +Guid Id
        +Guid BrandId
        +string Name
        +LoyaltyProgramType Type
        +int? StampThreshold
        +decimal? PointsConversionRate
        +int? DailyStampLimit
        +decimal? MinimumTransactionAmount
        +ExpirationPolicy ExpirationPolicy
        +CreateReward()
        +IsValidForStampIssuance()
        +IsValidForPointsIssuance()
    }
    
    class LoyaltyCard {
        +Guid Id
        +Guid ProgramId
        +Guid CustomerId
        +LoyaltyProgramType Type
        +int StampsCollected
        +decimal PointsBalance
        +CardStatus Status
        +DateTime CreatedAt
        +DateTime? ExpiresAt
        +IReadOnlyCollection~Transaction~ Transactions
        +IssueStamps()
        +AddPoints()
        +RedeemReward()
        +GetStampsIssuedToday()
    }
    
    class Transaction {
        +Guid Id
        +Guid CardId
        +TransactionType Type
        +Guid? RewardId
        +int? Quantity
        +decimal? PointsAmount
        +decimal? TransactionAmount
        +Guid StoreId
        +Guid? StaffId
        +string? PosTransactionId
        +DateTime Timestamp
        +IDictionary~string,string~ Metadata
    }
    
    class Reward {
        +Guid Id
        +Guid ProgramId
        +string Title
        +string Description
        +int RequiredValue
        +DateTime? ValidFrom
        +DateTime? ValidTo
        +bool IsActive
        +IsValidAt()
    }
    
    class Customer {
        +Guid Id
        +string Name
        +string Email
        +string Phone
        +DateTime JoinedAt
    }
    
    class LoyaltyProgramType {
        <<enumeration>>
        Stamp
        Points
    }
    
    class CardStatus {
        <<enumeration>>
        Active
        Expired
        Suspended
    }
    
    class TransactionType {
        <<enumeration>>
        StampIssuance
        PointsIssuance
        RewardRedemption
        StampVoid
        PointsVoid
    }
    
    Business "1" --> "*" Brand : owns
    Brand "1" --> "*" Store : has
    Brand "1" --> "*" LoyaltyProgram : offers
    LoyaltyProgram "1" --> "*" Reward : defines
    LoyaltyProgram "1" --> "*" LoyaltyCard : creates
    LoyaltyCard "1" --> "*" Transaction : records
    Customer "1" --> "*" LoyaltyCard : holds
    Transaction "*" --> "0..1" Reward : references
    Transaction "*" --> "1" Store : occurs at
```

## 2. Aggregate Boundaries

```mermaid
classDiagram
    class BusinessAggregate {
        <<aggregate root>>
        Business
        Collection~Brand~
    }
    
    class BrandAggregate {
        <<aggregate root>>
        Brand
        Collection~Store~
    }
    
    class LoyaltyProgramAggregate {
        <<aggregate root>>
        LoyaltyProgram
        Collection~Reward~
    }
    
    class LoyaltyCardAggregate {
        <<aggregate root>>
        LoyaltyCard
        Collection~Transaction~
    }
    
    class CustomerAggregate {
        <<aggregate root>>
        Customer
        CustomerSettings
    }
    
    BusinessAggregate "1" --> "*" BrandAggregate
    BrandAggregate "1" --> "*" LoyaltyProgramAggregate
    LoyaltyProgramAggregate "1" --> "*" LoyaltyCardAggregate
    CustomerAggregate "1" --> "*" LoyaltyCardAggregate
```

## 3. Key Workflows (Sequence Diagrams)

### 3.1 Stamp Issuance Workflow

```mermaid
sequenceDiagram
    participant Customer
    participant CompanionApp as Companion App
    participant API
    participant LoyaltyService
    participant CardRepo as LoyaltyCardRepository
    participant ProgramRepo as LoyaltyProgramRepository
    participant Card as LoyaltyCard
    
    Customer->>CompanionApp: Shows membership QR code
    CompanionApp->>API: Scan & identify customer
    API->>LoyaltyService: IssueStampsCommand
    LoyaltyService->>CardRepo: Get customer's loyalty card
    LoyaltyService->>ProgramRepo: Get program details
    LoyaltyService->>LoyaltyService: Check daily stamp limit
    
    alt Daily limit exceeded
        LoyaltyService-->>API: Return error
        API-->>CompanionApp: Show error message
    else Daily limit not exceeded
        LoyaltyService->>Card: Issue stamps & create transaction
        LoyaltyService->>CardRepo: Save updated card
        LoyaltyService-->>API: Return success
        API-->>CompanionApp: Show success message
        CompanionApp-->>Customer: Confirmation screen
    end
```

### 3.2 Points Addition via POS Integration

```mermaid
sequenceDiagram
    participant Customer
    participant POS
    participant API
    participant CardLinkService
    participant LoyaltyService
    participant CardRepo as LoyaltyCardRepository
    participant ProgramRepo as LoyaltyProgramRepository
    participant Card as LoyaltyCard
    
    Customer->>POS: Makes purchase with linked card
    POS->>API: Send transaction data (cardHash, amount)
    API->>CardLinkService: Lookup card ID from card hash
    
    alt Card not found
        CardLinkService-->>API: Card not found
        API-->>POS: Show error message
    else Card found
        CardLinkService-->>API: Return card ID
        API->>LoyaltyService: AddPointsCommand
        LoyaltyService->>CardRepo: Get customer's loyalty card
        LoyaltyService->>ProgramRepo: Get program details
        LoyaltyService->>LoyaltyService: Check transaction amount & calculate points
        
        alt Transaction amount too low
            LoyaltyService-->>API: Return error
            API-->>POS: Show error message
        else Transaction valid
            LoyaltyService->>Card: Add points & create transaction
            LoyaltyService->>CardRepo: Save updated card
            LoyaltyService-->>API: Return success with points added
            API-->>POS: Confirmation with points
            POS-->>Customer: Receipt showing points earned
        end
    end
```

### 3.3 Reward Redemption

```mermaid
sequenceDiagram
    participant Customer
    participant CompanionApp as Companion App
    participant Staff
    participant API
    participant RewardService
    participant LoyaltyService
    participant CardRepo as LoyaltyCardRepository
    participant RewardRepo as RewardRepository
    participant Card as LoyaltyCard
    
    Customer->>CompanionApp: Shows membership QR code
    CompanionApp->>API: Scan & identify customer
    CompanionApp->>API: Request available rewards
    API->>RewardService: Get rewards for customer
    RewardService-->>API: Return available rewards
    API-->>CompanionApp: Display rewards list
    CompanionApp->>Staff: Show available rewards
    Staff->>CompanionApp: Select reward to redeem
    CompanionApp->>API: RedeemRewardCommand
    API->>LoyaltyService: Process redemption
    LoyaltyService->>CardRepo: Get customer's loyalty card
    LoyaltyService->>RewardRepo: Get reward details
    
    alt Insufficient balance
        LoyaltyService-->>API: Return error
        API-->>CompanionApp: Show error message
    else Reward period invalid
        LoyaltyService-->>API: Return error
        API-->>CompanionApp: Show error message
    else Redemption valid
        LoyaltyService->>Card: Redeem reward & create transaction
        LoyaltyService->>CardRepo: Save updated card
        LoyaltyService-->>API: Return success
        API-->>CompanionApp: Confirmation details
        CompanionApp-->>Staff: Show redemption confirmation
        CompanionApp-->>Customer: Confirmation screen
    end
```

## 4. Entity Relationship Diagram (Database Schema)

```mermaid
erDiagram
    %% Core Entities
    BUSINESSES {
        UUID id PK
        string name
        string description
        string tax_id
        string logo_url
        string website
        datetime founded_date
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }
    
    BUSINESS_CONTACTS {
        UUID business_id PK,FK
        string email
        string phone
        string website
        timestamp created_at
        timestamp updated_at
    }
    
    BUSINESS_ADDRESSES {
        UUID business_id PK,FK
        string line1
        string line2
        string city
        string state
        string postal_code
        string country
        timestamp created_at
        timestamp updated_at
    }
    
    BRANDS {
        UUID id PK
        UUID business_id FK
        string name
        string category
        string logo_url
        string description
        timestamp created_at
        timestamp updated_at
    }
    
    BRAND_CONTACTS {
        UUID brand_id PK,FK
        string email
        string phone
        string website
        timestamp created_at
        timestamp updated_at
    }
    
    BRAND_ADDRESSES {
        UUID brand_id PK,FK
        string line1
        string line2
        string city
        string state
        string postal_code
        string country
        timestamp created_at
        timestamp updated_at
    }
    
    STORES {
        UUID id PK
        UUID brand_id FK
        string name
        timestamp created_at
        timestamp updated_at
    }
    
    STORE_CONTACTS {
        UUID store_id PK,FK
        string email
        string phone
        string website
        timestamp created_at
        timestamp updated_at
    }
    
    STORE_ADDRESSES {
        UUID store_id PK,FK
        string line1
        string line2
        string city
        string state
        string postal_code
        string country
        timestamp created_at
        timestamp updated_at
    }
    
    STORE_GEO_LOCATIONS {
        UUID store_id PK,FK
        float latitude
        float longitude
        timestamp created_at
        timestamp updated_at
    }
    
    STORE_OPERATING_HOURS {
        UUID store_id PK,FK
        int day_of_week PK
        time open_time
        time close_time
        timestamp created_at
        timestamp updated_at
    }
    
    %% Loyalty Program Entities
    LOYALTY_PROGRAMS {
        UUID id PK
        UUID brand_id FK
        string name
        enum program_type
        int stamp_threshold
        decimal points_conversion_rate
        int daily_stamp_limit
        decimal minimum_transaction_amount
        jsonb expiration_policy
        bool is_active
        timestamp created_at
        timestamp updated_at
    }
    
    REWARDS {
        UUID id PK
        UUID program_id FK
        string title
        string description
        int required_value
        timestamp valid_from
        timestamp valid_to
        bool is_active
        timestamp created_at
        timestamp updated_at
    }
    
    %% Customer Entities
    CUSTOMERS {
        UUID id PK
        string name
        string email
        string phone
        string password_hash
        string external_auth_id
        timestamp joined_at
        timestamp last_login
        bool marketing_consent
        timestamp created_at
        timestamp updated_at
    }
    
    LOYALTY_CARDS {
        UUID id PK
        UUID program_id FK
        UUID customer_id FK
        enum card_type
        int stamps_collected
        decimal points_balance
        enum status
        string qr_code
        timestamp expires_at
        timestamp created_at
        timestamp updated_at
    }
    
    %% Transaction Entities
    TRANSACTIONS {
        UUID id PK
        UUID card_id FK
        enum transaction_type
        UUID reward_id FK
        int quantity
        decimal points_amount
        decimal transaction_amount
        UUID store_id FK
        UUID staff_id FK
        string pos_transaction_id
        timestamp transaction_time
        jsonb metadata
        timestamp created_at
    }
    
    CARD_LINKS {
        UUID id PK
        UUID card_id FK
        string card_hash
        enum link_type
        bool is_active
        timestamp created_at
        timestamp updated_at
    }
    
    %% Staff Entities
    STAFF {
        UUID id PK
        UUID brand_id FK
        string name
        string email
        string phone
        string password_hash
        string pin_code
        enum role
        jsonb permissions
        timestamp created_at
        timestamp updated_at
    }
    
    STAFF_STORE_ASSIGNMENTS {
        UUID id PK
        UUID staff_id FK
        UUID store_id FK
        timestamp created_at
        timestamp updated_at
    }
    
    %% Business Relationships
    BUSINESSES ||--|| BUSINESS_CONTACTS : "has"
    BUSINESSES ||--|| BUSINESS_ADDRESSES : "has"
    BUSINESSES ||--o{ BRANDS : "owns"
    
    %% Brand Relationships
    BRANDS ||--|| BRAND_CONTACTS : "has"
    BRANDS ||--|| BRAND_ADDRESSES : "has"
    BRANDS ||--o{ STORES : "has"
    BRANDS ||--o{ LOYALTY_PROGRAMS : "offers"
    BRANDS ||--o{ STAFF : "employs"
    
    %% Store Relationships
    STORES ||--|| STORE_CONTACTS : "has"
    STORES ||--|| STORE_ADDRESSES : "has"
    STORES ||--|| STORE_GEO_LOCATIONS : "has"
    STORES ||--o{ STORE_OPERATING_HOURS : "has"
    
    %% Loyalty Program Relationships
    LOYALTY_PROGRAMS ||--o{ REWARDS : "defines"
    LOYALTY_PROGRAMS ||--o{ LOYALTY_CARDS : "creates"
    
    %% Customer Relationships
    CUSTOMERS ||--o{ LOYALTY_CARDS : "holds"
    
    %% Card Relationships
    LOYALTY_CARDS ||--o{ TRANSACTIONS : "records"
    LOYALTY_CARDS ||--o{ CARD_LINKS : "links to"
    
    %% Transaction Relationships
    STORES ||--o{ TRANSACTIONS : "location of"
    REWARDS ||--o{ TRANSACTIONS : "redeemed in"
    STAFF ||--o{ TRANSACTIONS : "performed by"
    
    %% Staff Relationships
    STAFF ||--o{ STAFF_STORE_ASSIGNMENTS : "assigned to"
    STORES ||--o{ STAFF_STORE_ASSIGNMENTS : "has assigned"
``` 